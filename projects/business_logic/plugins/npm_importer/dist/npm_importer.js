"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const static_analyser_1 = require("static_analyser");
const typescript_1 = require("typescript");
const path_1 = require("path");
const webpack_1 = require("./webpack");
function npmImporter(args) {
    return async (model, context) => {
        if (['node', 'electron'].includes(model.project.resolvedConfig.platform)) {
            return model;
        }
        context.uiLogger.info(`[${model.project.resolvedConfig.name}]Mapping npm imports`);
        if (!(await model.fileSystem.exists(path_1.join(model.project.path, 'package.json')))) {
            throw new Error(`Project ${model.project.resolvedConfig.name} is missing a package.json`);
        }
        const packageJson = JSON.parse(await model.fileSystem.readFile(path_1.join(model.project.path, 'package.json'), 'utf8'));
        const toLoad = new Set();
        for (const file of model.input) {
            if (file.endsWith('.ts') || file.endsWith('.tsx') || file.endsWith('.js') || file.endsWith('.jsx')) {
                await findDependencies(file, model, packageJson, toLoad);
            }
        }
        for (const name of toLoad) {
            await loadPackage(model, name);
        }
        return model;
    };
}
exports.npmImporter = npmImporter;
async function findDependencies(file, model, packageJson, toLoad) {
    const fm = new static_analyser_1.FileManipulator(await model.fileSystem.readFile(file, 'utf8'));
    fm.queryAst((node) => {
        if (typescript_1.isImportDeclaration(node)) {
            if (node.moduleSpecifier) {
                const moduleName = node.moduleSpecifier.text;
                if (!moduleName.startsWith('.')) {
                    const [name] = moduleName.split('/');
                    const target = model.allProjects.find((p) => p.resolvedConfig.name === name);
                    if (!target) {
                        if (packageJson.dependencies[name]) {
                            toLoad.add(name);
                        }
                    }
                }
            }
            return [];
        }
        else {
            return [];
        }
    });
}
async function loadPackage(model, pkg) {
    const result = await webpack_1.webpack.createBundle(model.fileSystem, {
        moduleName: pkg,
        externals: {},
        mode: 'production',
        entry: path_1.join(model.project.path, 'node_modules', pkg)
    });
    await model.fileSystem.mkdirp(path_1.join(model.project.path, 'build_assets', pkg));
    await model.fileSystem.writeFile(path_1.join(model.project.path, 'build_assets', pkg, 'bundle.js'), result);
    model.project.fileDependencies.set(pkg, path_1.join('build_assets', pkg, 'bundle.js'));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5wbV9pbXBvcnRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJucG1faW1wb3J0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBzdGF0aWNfYW5hbHlzZXJfMSA9IHJlcXVpcmUoXCJzdGF0aWNfYW5hbHlzZXJcIik7XG5jb25zdCB0eXBlc2NyaXB0XzEgPSByZXF1aXJlKFwidHlwZXNjcmlwdFwiKTtcbmNvbnN0IHBhdGhfMSA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3Qgd2VicGFja18xID0gcmVxdWlyZShcIi4vd2VicGFja1wiKTtcbmZ1bmN0aW9uIG5wbUltcG9ydGVyKGFyZ3MpIHtcbiAgICByZXR1cm4gYXN5bmMgKG1vZGVsLCBjb250ZXh0KSA9PiB7XG4gICAgICAgIGlmIChbJ25vZGUnLCAnZWxlY3Ryb24nXS5pbmNsdWRlcyhtb2RlbC5wcm9qZWN0LnJlc29sdmVkQ29uZmlnLnBsYXRmb3JtKSkge1xuICAgICAgICAgICAgcmV0dXJuIG1vZGVsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRleHQudWlMb2dnZXIuaW5mbyhgWyR7bW9kZWwucHJvamVjdC5yZXNvbHZlZENvbmZpZy5uYW1lfV1NYXBwaW5nIG5wbSBpbXBvcnRzYCk7XG4gICAgICAgIGlmICghKGF3YWl0IG1vZGVsLmZpbGVTeXN0ZW0uZXhpc3RzKHBhdGhfMS5qb2luKG1vZGVsLnByb2plY3QucGF0aCwgJ3BhY2thZ2UuanNvbicpKSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUHJvamVjdCAke21vZGVsLnByb2plY3QucmVzb2x2ZWRDb25maWcubmFtZX0gaXMgbWlzc2luZyBhIHBhY2thZ2UuanNvbmApO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHBhY2thZ2VKc29uID0gSlNPTi5wYXJzZShhd2FpdCBtb2RlbC5maWxlU3lzdGVtLnJlYWRGaWxlKHBhdGhfMS5qb2luKG1vZGVsLnByb2plY3QucGF0aCwgJ3BhY2thZ2UuanNvbicpLCAndXRmOCcpKTtcbiAgICAgICAgY29uc3QgdG9Mb2FkID0gbmV3IFNldCgpO1xuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgbW9kZWwuaW5wdXQpIHtcbiAgICAgICAgICAgIGlmIChmaWxlLmVuZHNXaXRoKCcudHMnKSB8fCBmaWxlLmVuZHNXaXRoKCcudHN4JykgfHwgZmlsZS5lbmRzV2l0aCgnLmpzJykgfHwgZmlsZS5lbmRzV2l0aCgnLmpzeCcpKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgZmluZERlcGVuZGVuY2llcyhmaWxlLCBtb2RlbCwgcGFja2FnZUpzb24sIHRvTG9hZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChjb25zdCBuYW1lIG9mIHRvTG9hZCkge1xuICAgICAgICAgICAgYXdhaXQgbG9hZFBhY2thZ2UobW9kZWwsIG5hbWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBtb2RlbDtcbiAgICB9O1xufVxuZXhwb3J0cy5ucG1JbXBvcnRlciA9IG5wbUltcG9ydGVyO1xuYXN5bmMgZnVuY3Rpb24gZmluZERlcGVuZGVuY2llcyhmaWxlLCBtb2RlbCwgcGFja2FnZUpzb24sIHRvTG9hZCkge1xuICAgIGNvbnN0IGZtID0gbmV3IHN0YXRpY19hbmFseXNlcl8xLkZpbGVNYW5pcHVsYXRvcihhd2FpdCBtb2RlbC5maWxlU3lzdGVtLnJlYWRGaWxlKGZpbGUsICd1dGY4JykpO1xuICAgIGZtLnF1ZXJ5QXN0KChub2RlKSA9PiB7XG4gICAgICAgIGlmICh0eXBlc2NyaXB0XzEuaXNJbXBvcnREZWNsYXJhdGlvbihub2RlKSkge1xuICAgICAgICAgICAgaWYgKG5vZGUubW9kdWxlU3BlY2lmaWVyKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbW9kdWxlTmFtZSA9IG5vZGUubW9kdWxlU3BlY2lmaWVyLnRleHQ7XG4gICAgICAgICAgICAgICAgaWYgKCFtb2R1bGVOYW1lLnN0YXJ0c1dpdGgoJy4nKSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBbbmFtZV0gPSBtb2R1bGVOYW1lLnNwbGl0KCcvJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IG1vZGVsLmFsbFByb2plY3RzLmZpbmQoKHApID0+IHAucmVzb2x2ZWRDb25maWcubmFtZSA9PT0gbmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFja2FnZUpzb24uZGVwZW5kZW5jaWVzW25hbWVdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9Mb2FkLmFkZChuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBbXTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuYXN5bmMgZnVuY3Rpb24gbG9hZFBhY2thZ2UobW9kZWwsIHBrZykge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHdlYnBhY2tfMS53ZWJwYWNrLmNyZWF0ZUJ1bmRsZShtb2RlbC5maWxlU3lzdGVtLCB7XG4gICAgICAgIG1vZHVsZU5hbWU6IHBrZyxcbiAgICAgICAgZXh0ZXJuYWxzOiB7fSxcbiAgICAgICAgbW9kZTogJ3Byb2R1Y3Rpb24nLFxuICAgICAgICBlbnRyeTogcGF0aF8xLmpvaW4obW9kZWwucHJvamVjdC5wYXRoLCAnbm9kZV9tb2R1bGVzJywgcGtnKVxuICAgIH0pO1xuICAgIGF3YWl0IG1vZGVsLmZpbGVTeXN0ZW0ubWtkaXJwKHBhdGhfMS5qb2luKG1vZGVsLnByb2plY3QucGF0aCwgJ2J1aWxkX2Fzc2V0cycsIHBrZykpO1xuICAgIGF3YWl0IG1vZGVsLmZpbGVTeXN0ZW0ud3JpdGVGaWxlKHBhdGhfMS5qb2luKG1vZGVsLnByb2plY3QucGF0aCwgJ2J1aWxkX2Fzc2V0cycsIHBrZywgJ2J1bmRsZS5qcycpLCByZXN1bHQpO1xuICAgIG1vZGVsLnByb2plY3QuZmlsZURlcGVuZGVuY2llcy5zZXQocGtnLCBwYXRoXzEuam9pbignYnVpbGRfYXNzZXRzJywgcGtnLCAnYnVuZGxlLmpzJykpO1xufVxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZGF0YTphcHBsaWNhdGlvbi9qc29uO2Jhc2U2NCxleUoyWlhKemFXOXVJam96TENKbWFXeGxJam9pYm5CdFgybHRjRzl5ZEdWeUxtcHpJaXdpYzI5MWNtTmxVbTl2ZENJNklpSXNJbk52ZFhKalpYTWlPbHNpYm5CdFgybHRjRzl5ZEdWeUxtcHpJbDBzSW01aGJXVnpJanBiWFN3aWJXRndjR2x1WjNNaU9pSTdPMEZCUVVFc2NVUkJRV3RFTzBGQlEyeEVMREpEUVVGcFJEdEJRVU5xUkN3clFrRkJORUk3UVVGRE5VSXNkVU5CUVc5RE8wRkJRM0JETEZOQlFXZENMRmRCUVZjc1EwRkJReXhKUVVGSk8wbEJRelZDTEU5QlFVOHNTMEZCU3l4RlFVRkZMRXRCUVVzc1JVRkJSU3hQUVVGUExFVkJRVVVzUlVGQlJUdFJRVU0xUWl4SlFVRkpMRU5CUVVNc1RVRkJUU3hGUVVGRkxGVkJRVlVzUTBGQlF5eERRVUZETEZGQlFWRXNRMEZCUXl4TFFVRkxMRU5CUVVNc1QwRkJUeXhEUVVGRExHTkJRV01zUTBGQlF5eFJRVUZSTEVOQlFVTXNSVUZCUlR0WlFVTjBSU3hQUVVGUExFdEJRVXNzUTBGQlF6dFRRVU5vUWp0UlFVTkVMRTlCUVU4c1EwRkJReXhSUVVGUkxFTkJRVU1zU1VGQlNTeERRVUZETEVsQlFVa3NTMEZCU3l4RFFVRkRMRTlCUVU4c1EwRkJReXhqUVVGakxFTkJRVU1zU1VGQlNTeHpRa0ZCYzBJc1EwRkJReXhEUVVGRE8xRkJRMjVHTEVsQlFVa3NRMEZCUXl4RFFVRkRMRTFCUVUwc1MwRkJTeXhEUVVGRExGVkJRVlVzUTBGQlF5eE5RVUZOTEVOQlFVTXNWMEZCU1N4RFFVRkRMRXRCUVVzc1EwRkJReXhQUVVGUExFTkJRVU1zU1VGQlNTeEZRVUZGTEdOQlFXTXNRMEZCUXl4RFFVRkRMRU5CUVVNc1JVRkJSVHRaUVVNMVJTeE5RVUZOTEVsQlFVa3NTMEZCU3l4RFFVRkRMRmRCUVZjc1MwRkJTeXhEUVVGRExFOUJRVThzUTBGQlF5eGpRVUZqTEVOQlFVTXNTVUZCU1N3MFFrRkJORUlzUTBGQlF5eERRVUZETzFOQlF6ZEdPMUZCUTBRc1RVRkJUU3hYUVVGWExFZEJRVWNzU1VGQlNTeERRVUZETEV0QlFVc3NRMEZCUXl4TlFVRk5MRXRCUVVzc1EwRkJReXhWUVVGVkxFTkJRVU1zVVVGQlVTeERRVUZETEZkQlFVa3NRMEZCUXl4TFFVRkxMRU5CUVVNc1QwRkJUeXhEUVVGRExFbEJRVWtzUlVGQlJTeGpRVUZqTEVOQlFVTXNSVUZCUlN4TlFVRk5MRU5CUVVNc1EwRkJReXhEUVVGRE8xRkJRMnhJTEUxQlFVMHNUVUZCVFN4SFFVRkhMRWxCUVVrc1IwRkJSeXhGUVVGRkxFTkJRVU03VVVGRGVrSXNTMEZCU3l4TlFVRk5MRWxCUVVrc1NVRkJTU3hMUVVGTExFTkJRVU1zUzBGQlN5eEZRVUZGTzFsQlF6VkNMRWxCUVVrc1NVRkJTU3hEUVVGRExGRkJRVkVzUTBGQlF5eExRVUZMTEVOQlFVTXNTVUZCU1N4SlFVRkpMRU5CUVVNc1VVRkJVU3hEUVVGRExFMUJRVTBzUTBGQlF5eEpRVUZKTEVsQlFVa3NRMEZCUXl4UlFVRlJMRU5CUVVNc1MwRkJTeXhEUVVGRExFbEJRVWtzU1VGQlNTeERRVUZETEZGQlFWRXNRMEZCUXl4TlFVRk5MRU5CUVVNc1JVRkJSVHRuUWtGRGFFY3NUVUZCVFN4blFrRkJaMElzUTBGQlF5eEpRVUZKTEVWQlFVVXNTMEZCU3l4RlFVRkZMRmRCUVZjc1JVRkJSU3hOUVVGTkxFTkJRVU1zUTBGQlF6dGhRVU0xUkR0VFFVTktPMUZCUTBRc1MwRkJTeXhOUVVGTkxFbEJRVWtzU1VGQlNTeE5RVUZOTEVWQlFVVTdXVUZEZGtJc1RVRkJUU3hYUVVGWExFTkJRVU1zUzBGQlN5eEZRVUZGTEVsQlFVa3NRMEZCUXl4RFFVRkRPMU5CUTJ4RE8xRkJRMFFzVDBGQlR5eExRVUZMTEVOQlFVTTdTVUZEYWtJc1EwRkJReXhEUVVGRE8wRkJRMDRzUTBGQlF6dEJRWEpDUkN4clEwRnhRa003UVVGRFJDeExRVUZMTEZWQlFWVXNaMEpCUVdkQ0xFTkJRVU1zU1VGQlNTeEZRVUZGTEV0QlFVc3NSVUZCUlN4WFFVRlhMRVZCUVVVc1RVRkJUVHRKUVVNMVJDeE5RVUZOTEVWQlFVVXNSMEZCUnl4SlFVRkpMR2xEUVVGbExFTkJRVU1zVFVGQlRTeExRVUZMTEVOQlFVTXNWVUZCVlN4RFFVRkRMRkZCUVZFc1EwRkJReXhKUVVGSkxFVkJRVVVzVFVGQlRTeERRVUZETEVOQlFVTXNRMEZCUXp0SlFVTTVSU3hGUVVGRkxFTkJRVU1zVVVGQlVTeERRVUZETEVOQlFVTXNTVUZCU1N4RlFVRkZMRVZCUVVVN1VVRkRha0lzU1VGQlNTeG5RMEZCYlVJc1EwRkJReXhKUVVGSkxFTkJRVU1zUlVGQlJUdFpRVU16UWl4SlFVRkpMRWxCUVVrc1EwRkJReXhsUVVGbExFVkJRVVU3WjBKQlEzUkNMRTFCUVUwc1ZVRkJWU3hIUVVGSExFbEJRVWtzUTBGQlF5eGxRVUZsTEVOQlFVTXNTVUZCU1N4RFFVRkRPMmRDUVVNM1F5eEpRVUZKTEVOQlFVTXNWVUZCVlN4RFFVRkRMRlZCUVZVc1EwRkJReXhIUVVGSExFTkJRVU1zUlVGQlJUdHZRa0ZETjBJc1RVRkJUU3hEUVVGRExFbEJRVWtzUTBGQlF5eEhRVUZITEZWQlFWVXNRMEZCUXl4TFFVRkxMRU5CUVVNc1IwRkJSeXhEUVVGRExFTkJRVU03YjBKQlEzSkRMRTFCUVUwc1RVRkJUU3hIUVVGSExFdEJRVXNzUTBGQlF5eFhRVUZYTEVOQlFVTXNTVUZCU1N4RFFVRkRMRU5CUVVNc1EwRkJReXhGUVVGRkxFVkJRVVVzUTBGQlF5eERRVUZETEVOQlFVTXNZMEZCWXl4RFFVRkRMRWxCUVVrc1MwRkJTeXhKUVVGSkxFTkJRVU1zUTBGQlF6dHZRa0ZETjBVc1NVRkJTU3hEUVVGRExFMUJRVTBzUlVGQlJUdDNRa0ZEVkN4SlFVRkpMRmRCUVZjc1EwRkJReXhaUVVGWkxFTkJRVU1zU1VGQlNTeERRVUZETEVWQlFVVTdORUpCUTJoRExFMUJRVTBzUTBGQlF5eEhRVUZITEVOQlFVTXNTVUZCU1N4RFFVRkRMRU5CUVVNN2VVSkJRM0JDTzNGQ1FVTktPMmxDUVVOS08yRkJRMG83V1VGRFJDeFBRVUZQTEVWQlFVVXNRMEZCUXp0VFFVTmlPMkZCUTBrN1dVRkRSQ3hQUVVGUExFVkJRVVVzUTBGQlF6dFRRVU5pTzBsQlEwd3NRMEZCUXl4RFFVRkRMRU5CUVVNN1FVRkRVQ3hEUVVGRE8wRkJRMFFzUzBGQlN5eFZRVUZWTEZkQlFWY3NRMEZCUXl4TFFVRkxMRVZCUVVVc1IwRkJSenRKUVVOcVF5eE5RVUZOTEUxQlFVMHNSMEZCUnl4TlFVRk5MR2xDUVVGUExFTkJRVU1zV1VGQldTeERRVUZETEV0QlFVc3NRMEZCUXl4VlFVRlZMRVZCUVVVN1VVRkRlRVFzVlVGQlZTeEZRVUZGTEVkQlFVYzdVVUZEWml4VFFVRlRMRVZCUVVVc1JVRkJSVHRSUVVOaUxFbEJRVWtzUlVGQlJTeFpRVUZaTzFGQlEyeENMRXRCUVVzc1JVRkJSU3hYUVVGSkxFTkJRVU1zUzBGQlN5eERRVUZETEU5QlFVOHNRMEZCUXl4SlFVRkpMRVZCUVVVc1kwRkJZeXhGUVVGRkxFZEJRVWNzUTBGQlF6dExRVU4yUkN4RFFVRkRMRU5CUVVNN1NVRkRTQ3hOUVVGTkxFdEJRVXNzUTBGQlF5eFZRVUZWTEVOQlFVTXNUVUZCVFN4RFFVRkRMRmRCUVVrc1EwRkJReXhMUVVGTExFTkJRVU1zVDBGQlR5eERRVUZETEVsQlFVa3NSVUZCUlN4alFVRmpMRVZCUVVVc1IwRkJSeXhEUVVGRExFTkJRVU1zUTBGQlF6dEpRVU0zUlN4TlFVRk5MRXRCUVVzc1EwRkJReXhWUVVGVkxFTkJRVU1zVTBGQlV5eERRVUZETEZkQlFVa3NRMEZCUXl4TFFVRkxMRU5CUVVNc1QwRkJUeXhEUVVGRExFbEJRVWtzUlVGQlJTeGpRVUZqTEVWQlFVVXNSMEZCUnl4RlFVRkZMRmRCUVZjc1EwRkJReXhGUVVGRkxFMUJRVTBzUTBGQlF5eERRVUZETzBsQlEzSkhMRXRCUVVzc1EwRkJReXhQUVVGUExFTkJRVU1zWjBKQlFXZENMRU5CUVVNc1IwRkJSeXhEUVVGRExFZEJRVWNzUlVGQlJTeFhRVUZKTEVOQlFVTXNZMEZCWXl4RlFVRkZMRWRCUVVjc1JVRkJSU3hYUVVGWExFTkJRVU1zUTBGQlF5eERRVUZETzBGQlEzQkdMRU5CUVVNaWZRPT0iXX0=