"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const static_analyser_1 = require("static_analyser");
const typescript_1 = require("typescript");
const path_1 = require("path");
const webpack_1 = require("./webpack");
function npmImporter(args) {
    return async (model, context) => {
        if (['node', 'electron'].includes(model.project.resolvedConfig.platform)) {
            return model;
        }
        context.uiLogger.info(`[${model.project.resolvedConfig.name}]Mapping npm imports`);
        if (!(await model.fileSystem.exists(path_1.join(model.project.path, 'package.json')))) {
            throw new Error(`Project ${model.project.resolvedConfig.name} is missing a package.json`);
        }
        const packageJson = JSON.parse(await model.fileSystem.readFile(path_1.join(model.project.path, 'package.json'), 'utf8'));
        const toLoad = new Set();
        for (const file of model.input) {
            if (file.endsWith('.ts') || file.endsWith('.tsx') || file.endsWith('.js') || file.endsWith('.jsx')) {
                await findDependencies(file, model, packageJson, toLoad);
            }
        }
        for (const name of toLoad) {
            await loadPackage(model, name);
        }
        return model;
    };
}
exports.npmImporter = npmImporter;
async function findDependencies(file, model, packageJson, toLoad) {
    const fm = new static_analyser_1.FileManipulator(await model.fileSystem.readFile(file, 'utf8'));
    fm.queryAst((node) => {
        if (typescript_1.isImportDeclaration(node)) {
            if (node.moduleSpecifier) {
                const moduleName = node.moduleSpecifier.text;
                if (!moduleName.startsWith('.')) {
                    const [name] = moduleName.split('/');
                    const target = model.allProjects.find((p) => p.resolvedConfig.name === name);
                    if (!target) {
                        if (packageJson.dependencies[name]) {
                            toLoad.add(name);
                        }
                    }
                }
            }
            return [];
        }
        else {
            return [];
        }
    });
}
async function loadPackage(model, pkg) {
    const result = await webpack_1.webpack.createBundle(model.fileSystem, {
        moduleName: pkg,
        externals: {},
        mode: 'production',
        entry: path_1.join(model.project.path, 'node_modules', pkg, 'package.json')
    });
    await model.fileSystem.mkdirp(path_1.join(model.project.path, 'build_assets', pkg));
    await model.fileSystem.writeFile(path_1.join(model.project.path, 'build_assets', pkg, 'bundle.js'), result);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5wbV9pbXBvcnRlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibnBtX2ltcG9ydGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuY29uc3Qgc3RhdGljX2FuYWx5c2VyXzEgPSByZXF1aXJlKFwic3RhdGljX2FuYWx5c2VyXCIpO1xuY29uc3QgdHlwZXNjcmlwdF8xID0gcmVxdWlyZShcInR5cGVzY3JpcHRcIik7XG5jb25zdCBwYXRoXzEgPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHdlYnBhY2tfMSA9IHJlcXVpcmUoXCIuL3dlYnBhY2tcIik7XG5mdW5jdGlvbiBucG1JbXBvcnRlcihhcmdzKSB7XG4gICAgcmV0dXJuIGFzeW5jIChtb2RlbCwgY29udGV4dCkgPT4ge1xuICAgICAgICBpZiAoWydub2RlJywgJ2VsZWN0cm9uJ10uaW5jbHVkZXMobW9kZWwucHJvamVjdC5yZXNvbHZlZENvbmZpZy5wbGF0Zm9ybSkpIHtcbiAgICAgICAgICAgIHJldHVybiBtb2RlbDtcbiAgICAgICAgfVxuICAgICAgICBjb250ZXh0LnVpTG9nZ2VyLmluZm8oYFske21vZGVsLnByb2plY3QucmVzb2x2ZWRDb25maWcubmFtZX1dTWFwcGluZyBucG0gaW1wb3J0c2ApO1xuICAgICAgICBpZiAoIShhd2FpdCBtb2RlbC5maWxlU3lzdGVtLmV4aXN0cyhwYXRoXzEuam9pbihtb2RlbC5wcm9qZWN0LnBhdGgsICdwYWNrYWdlLmpzb24nKSkpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb2plY3QgJHttb2RlbC5wcm9qZWN0LnJlc29sdmVkQ29uZmlnLm5hbWV9IGlzIG1pc3NpbmcgYSBwYWNrYWdlLmpzb25gKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwYWNrYWdlSnNvbiA9IEpTT04ucGFyc2UoYXdhaXQgbW9kZWwuZmlsZVN5c3RlbS5yZWFkRmlsZShwYXRoXzEuam9pbihtb2RlbC5wcm9qZWN0LnBhdGgsICdwYWNrYWdlLmpzb24nKSwgJ3V0ZjgnKSk7XG4gICAgICAgIGNvbnN0IHRvTG9hZCA9IG5ldyBTZXQoKTtcbiAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIG1vZGVsLmlucHV0KSB7XG4gICAgICAgICAgICBpZiAoZmlsZS5lbmRzV2l0aCgnLnRzJykgfHwgZmlsZS5lbmRzV2l0aCgnLnRzeCcpIHx8IGZpbGUuZW5kc1dpdGgoJy5qcycpIHx8IGZpbGUuZW5kc1dpdGgoJy5qc3gnKSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IGZpbmREZXBlbmRlbmNpZXMoZmlsZSwgbW9kZWwsIHBhY2thZ2VKc29uLCB0b0xvYWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgbmFtZSBvZiB0b0xvYWQpIHtcbiAgICAgICAgICAgIGF3YWl0IGxvYWRQYWNrYWdlKG1vZGVsLCBuYW1lKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbW9kZWw7XG4gICAgfTtcbn1cbmV4cG9ydHMubnBtSW1wb3J0ZXIgPSBucG1JbXBvcnRlcjtcbmFzeW5jIGZ1bmN0aW9uIGZpbmREZXBlbmRlbmNpZXMoZmlsZSwgbW9kZWwsIHBhY2thZ2VKc29uLCB0b0xvYWQpIHtcbiAgICBjb25zdCBmbSA9IG5ldyBzdGF0aWNfYW5hbHlzZXJfMS5GaWxlTWFuaXB1bGF0b3IoYXdhaXQgbW9kZWwuZmlsZVN5c3RlbS5yZWFkRmlsZShmaWxlLCAndXRmOCcpKTtcbiAgICBmbS5xdWVyeUFzdCgobm9kZSkgPT4ge1xuICAgICAgICBpZiAodHlwZXNjcmlwdF8xLmlzSW1wb3J0RGVjbGFyYXRpb24obm9kZSkpIHtcbiAgICAgICAgICAgIGlmIChub2RlLm1vZHVsZVNwZWNpZmllcikge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZU5hbWUgPSBub2RlLm1vZHVsZVNwZWNpZmllci50ZXh0O1xuICAgICAgICAgICAgICAgIGlmICghbW9kdWxlTmFtZS5zdGFydHNXaXRoKCcuJykpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgW25hbWVdID0gbW9kdWxlTmFtZS5zcGxpdCgnLycpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBtb2RlbC5hbGxQcm9qZWN0cy5maW5kKChwKSA9PiBwLnJlc29sdmVkQ29uZmlnLm5hbWUgPT09IG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRhcmdldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhY2thZ2VKc29uLmRlcGVuZGVuY2llc1tuYW1lXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvTG9hZC5hZGQobmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gW107XG4gICAgICAgIH1cbiAgICB9KTtcbn1cbmFzeW5jIGZ1bmN0aW9uIGxvYWRQYWNrYWdlKG1vZGVsLCBwa2cpIHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB3ZWJwYWNrXzEud2VicGFjay5jcmVhdGVCdW5kbGUobW9kZWwuZmlsZVN5c3RlbSwge1xuICAgICAgICBtb2R1bGVOYW1lOiBwa2csXG4gICAgICAgIGV4dGVybmFsczoge30sXG4gICAgICAgIG1vZGU6ICdwcm9kdWN0aW9uJyxcbiAgICAgICAgZW50cnk6IHBhdGhfMS5qb2luKG1vZGVsLnByb2plY3QucGF0aCwgJ25vZGVfbW9kdWxlcycsIHBrZywgJ3BhY2thZ2UuanNvbicpXG4gICAgfSk7XG4gICAgYXdhaXQgbW9kZWwuZmlsZVN5c3RlbS5ta2RpcnAocGF0aF8xLmpvaW4obW9kZWwucHJvamVjdC5wYXRoLCAnYnVpbGRfYXNzZXRzJywgcGtnKSk7XG4gICAgYXdhaXQgbW9kZWwuZmlsZVN5c3RlbS53cml0ZUZpbGUocGF0aF8xLmpvaW4obW9kZWwucHJvamVjdC5wYXRoLCAnYnVpbGRfYXNzZXRzJywgcGtnLCAnYnVuZGxlLmpzJyksIHJlc3VsdCk7XG59XG4vLyMgc291cmNlTWFwcGluZ1VSTD1kYXRhOmFwcGxpY2F0aW9uL2pzb247YmFzZTY0LGV5SjJaWEp6YVc5dUlqb3pMQ0ptYVd4bElqb2libkJ0WDJsdGNHOXlkR1Z5TG1weklpd2ljMjkxY21ObFVtOXZkQ0k2SWlJc0luTnZkWEpqWlhNaU9sc2libkJ0WDJsdGNHOXlkR1Z5TG1weklsMHNJbTVoYldWeklqcGJYU3dpYldGd2NHbHVaM01pT2lJN08wRkJRVUVzY1VSQlFXdEVPMEZCUTJ4RUxESkRRVUZwUkR0QlFVTnFSQ3dyUWtGQk5FSTdRVUZETlVJc2RVTkJRVzlETzBGQlEzQkRMRk5CUVdkQ0xGZEJRVmNzUTBGQlF5eEpRVUZKTzBsQlF6VkNMRTlCUVU4c1MwRkJTeXhGUVVGRkxFdEJRVXNzUlVGQlJTeFBRVUZQTEVWQlFVVXNSVUZCUlR0UlFVTTFRaXhKUVVGSkxFTkJRVU1zVFVGQlRTeEZRVUZGTEZWQlFWVXNRMEZCUXl4RFFVRkRMRkZCUVZFc1EwRkJReXhMUVVGTExFTkJRVU1zVDBGQlR5eERRVUZETEdOQlFXTXNRMEZCUXl4UlFVRlJMRU5CUVVNc1JVRkJSVHRaUVVOMFJTeFBRVUZQTEV0QlFVc3NRMEZCUXp0VFFVTm9RanRSUVVORUxFOUJRVThzUTBGQlF5eFJRVUZSTEVOQlFVTXNTVUZCU1N4RFFVRkRMRWxCUVVrc1MwRkJTeXhEUVVGRExFOUJRVThzUTBGQlF5eGpRVUZqTEVOQlFVTXNTVUZCU1N4elFrRkJjMElzUTBGQlF5eERRVUZETzFGQlEyNUdMRWxCUVVrc1EwRkJReXhEUVVGRExFMUJRVTBzUzBGQlN5eERRVUZETEZWQlFWVXNRMEZCUXl4TlFVRk5MRU5CUVVNc1YwRkJTU3hEUVVGRExFdEJRVXNzUTBGQlF5eFBRVUZQTEVOQlFVTXNTVUZCU1N4RlFVRkZMR05CUVdNc1EwRkJReXhEUVVGRExFTkJRVU1zUlVGQlJUdFpRVU0xUlN4TlFVRk5MRWxCUVVrc1MwRkJTeXhEUVVGRExGZEJRVmNzUzBGQlN5eERRVUZETEU5QlFVOHNRMEZCUXl4alFVRmpMRU5CUVVNc1NVRkJTU3cwUWtGQk5FSXNRMEZCUXl4RFFVRkRPMU5CUXpkR08xRkJRMFFzVFVGQlRTeFhRVUZYTEVkQlFVY3NTVUZCU1N4RFFVRkRMRXRCUVVzc1EwRkJReXhOUVVGTkxFdEJRVXNzUTBGQlF5eFZRVUZWTEVOQlFVTXNVVUZCVVN4RFFVRkRMRmRCUVVrc1EwRkJReXhMUVVGTExFTkJRVU1zVDBGQlR5eERRVUZETEVsQlFVa3NSVUZCUlN4alFVRmpMRU5CUVVNc1JVRkJSU3hOUVVGTkxFTkJRVU1zUTBGQlF5eERRVUZETzFGQlEyeElMRTFCUVUwc1RVRkJUU3hIUVVGSExFbEJRVWtzUjBGQlJ5eEZRVUZGTEVOQlFVTTdVVUZEZWtJc1MwRkJTeXhOUVVGTkxFbEJRVWtzU1VGQlNTeExRVUZMTEVOQlFVTXNTMEZCU3l4RlFVRkZPMWxCUXpWQ0xFbEJRVWtzU1VGQlNTeERRVUZETEZGQlFWRXNRMEZCUXl4TFFVRkxMRU5CUVVNc1NVRkJTU3hKUVVGSkxFTkJRVU1zVVVGQlVTeERRVUZETEUxQlFVMHNRMEZCUXl4SlFVRkpMRWxCUVVrc1EwRkJReXhSUVVGUkxFTkJRVU1zUzBGQlN5eERRVUZETEVsQlFVa3NTVUZCU1N4RFFVRkRMRkZCUVZFc1EwRkJReXhOUVVGTkxFTkJRVU1zUlVGQlJUdG5Ra0ZEYUVjc1RVRkJUU3huUWtGQlowSXNRMEZCUXl4SlFVRkpMRVZCUVVVc1MwRkJTeXhGUVVGRkxGZEJRVmNzUlVGQlJTeE5RVUZOTEVOQlFVTXNRMEZCUXp0aFFVTTFSRHRUUVVOS08xRkJRMFFzUzBGQlN5eE5RVUZOTEVsQlFVa3NTVUZCU1N4TlFVRk5MRVZCUVVVN1dVRkRka0lzVFVGQlRTeFhRVUZYTEVOQlFVTXNTMEZCU3l4RlFVRkZMRWxCUVVrc1EwRkJReXhEUVVGRE8xTkJRMnhETzFGQlEwUXNUMEZCVHl4TFFVRkxMRU5CUVVNN1NVRkRha0lzUTBGQlF5eERRVUZETzBGQlEwNHNRMEZCUXp0QlFYSkNSQ3hyUTBGeFFrTTdRVUZEUkN4TFFVRkxMRlZCUVZVc1owSkJRV2RDTEVOQlFVTXNTVUZCU1N4RlFVRkZMRXRCUVVzc1JVRkJSU3hYUVVGWExFVkJRVVVzVFVGQlRUdEpRVU0xUkN4TlFVRk5MRVZCUVVVc1IwRkJSeXhKUVVGSkxHbERRVUZsTEVOQlFVTXNUVUZCVFN4TFFVRkxMRU5CUVVNc1ZVRkJWU3hEUVVGRExGRkJRVkVzUTBGQlF5eEpRVUZKTEVWQlFVVXNUVUZCVFN4RFFVRkRMRU5CUVVNc1EwRkJRenRKUVVNNVJTeEZRVUZGTEVOQlFVTXNVVUZCVVN4RFFVRkRMRU5CUVVNc1NVRkJTU3hGUVVGRkxFVkJRVVU3VVVGRGFrSXNTVUZCU1N4blEwRkJiVUlzUTBGQlF5eEpRVUZKTEVOQlFVTXNSVUZCUlR0WlFVTXpRaXhKUVVGSkxFbEJRVWtzUTBGQlF5eGxRVUZsTEVWQlFVVTdaMEpCUTNSQ0xFMUJRVTBzVlVGQlZTeEhRVUZITEVsQlFVa3NRMEZCUXl4bFFVRmxMRU5CUVVNc1NVRkJTU3hEUVVGRE8yZENRVU0zUXl4SlFVRkpMRU5CUVVNc1ZVRkJWU3hEUVVGRExGVkJRVlVzUTBGQlF5eEhRVUZITEVOQlFVTXNSVUZCUlR0dlFrRkROMElzVFVGQlRTeERRVUZETEVsQlFVa3NRMEZCUXl4SFFVRkhMRlZCUVZVc1EwRkJReXhMUVVGTExFTkJRVU1zUjBGQlJ5eERRVUZETEVOQlFVTTdiMEpCUTNKRExFMUJRVTBzVFVGQlRTeEhRVUZITEV0QlFVc3NRMEZCUXl4WFFVRlhMRU5CUVVNc1NVRkJTU3hEUVVGRExFTkJRVU1zUTBGQlF5eEZRVUZGTEVWQlFVVXNRMEZCUXl4RFFVRkRMRU5CUVVNc1kwRkJZeXhEUVVGRExFbEJRVWtzUzBGQlN5eEpRVUZKTEVOQlFVTXNRMEZCUXp0dlFrRkROMFVzU1VGQlNTeERRVUZETEUxQlFVMHNSVUZCUlR0M1FrRkRWQ3hKUVVGSkxGZEJRVmNzUTBGQlF5eFpRVUZaTEVOQlFVTXNTVUZCU1N4RFFVRkRMRVZCUVVVN05FSkJRMmhETEUxQlFVMHNRMEZCUXl4SFFVRkhMRU5CUVVNc1NVRkJTU3hEUVVGRExFTkJRVU03ZVVKQlEzQkNPM0ZDUVVOS08ybENRVU5LTzJGQlEwbzdXVUZEUkN4UFFVRlBMRVZCUVVVc1EwRkJRenRUUVVOaU8yRkJRMGs3V1VGRFJDeFBRVUZQTEVWQlFVVXNRMEZCUXp0VFFVTmlPMGxCUTB3c1EwRkJReXhEUVVGRExFTkJRVU03UVVGRFVDeERRVUZETzBGQlEwUXNTMEZCU3l4VlFVRlZMRmRCUVZjc1EwRkJReXhMUVVGTExFVkJRVVVzUjBGQlJ6dEpRVU5xUXl4TlFVRk5MRTFCUVUwc1IwRkJSeXhOUVVGTkxHbENRVUZQTEVOQlFVTXNXVUZCV1N4RFFVRkRMRXRCUVVzc1EwRkJReXhWUVVGVkxFVkJRVVU3VVVGRGVFUXNWVUZCVlN4RlFVRkZMRWRCUVVjN1VVRkRaaXhUUVVGVExFVkJRVVVzUlVGQlJUdFJRVU5pTEVsQlFVa3NSVUZCUlN4WlFVRlpPMUZCUTJ4Q0xFdEJRVXNzUlVGQlJTeFhRVUZKTEVOQlFVTXNTMEZCU3l4RFFVRkRMRTlCUVU4c1EwRkJReXhKUVVGSkxFVkJRVVVzWTBGQll5eEZRVUZGTEVkQlFVY3NSVUZCUlN4alFVRmpMRU5CUVVNN1MwRkRka1VzUTBGQlF5eERRVUZETzBsQlEwZ3NUVUZCVFN4TFFVRkxMRU5CUVVNc1ZVRkJWU3hEUVVGRExFMUJRVTBzUTBGQlF5eFhRVUZKTEVOQlFVTXNTMEZCU3l4RFFVRkRMRTlCUVU4c1EwRkJReXhKUVVGSkxFVkJRVVVzWTBGQll5eEZRVUZGTEVkQlFVY3NRMEZCUXl4RFFVRkRMRU5CUVVNN1NVRkROMFVzVFVGQlRTeExRVUZMTEVOQlFVTXNWVUZCVlN4RFFVRkRMRk5CUVZNc1EwRkJReXhYUVVGSkxFTkJRVU1zUzBGQlN5eERRVUZETEU5QlFVOHNRMEZCUXl4SlFVRkpMRVZCUVVVc1kwRkJZeXhGUVVGRkxFZEJRVWNzUlVGQlJTeFhRVUZYTEVOQlFVTXNSVUZCUlN4TlFVRk5MRU5CUVVNc1EwRkJRenRCUVVONlJ5eERRVUZESW4wPSJdfQ==