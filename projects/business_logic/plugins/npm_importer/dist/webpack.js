"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const wp = require("webpack");
class Webpack {
    createBundle(fileSystem, options) {
        return new Promise((resolve, reject) => {
            var _a;
            const config = {
                mode: (_a = options.mode, (_a !== null && _a !== void 0 ? _a : 'development')),
                entry: options.entry,
                output: {
                    filename: 'bundle.js',
                    path: '/out',
                    library: options.moduleName,
                    libraryTarget: 'amd'
                },
                context: '/',
                resolve: {
                    extensions: ['.js', '.json']
                },
                externals: options.externals
            };
            const compiler = wp(config);
            compiler.inputFileSystem = {
                readFileSync: (path) => fileSystem.readFileSync(path),
                readlinkSync: (path) => fileSystem.readlinkSync(path),
                statSync: (path) => fileSystem.statSync(path),
                readFile: (path, cb) => {
                    fileSystem.readFile(path, 'utf8').then((res) => {
                        cb(undefined, Buffer.from(res));
                    }, (error) => {
                        cb(error, undefined);
                    });
                },
                readlink: (path, cb) => {
                    fileSystem.readlink(path).then((res) => {
                        cb(undefined, res);
                    }, (error) => {
                        cb(error, undefined);
                    });
                },
                stat: (path, cb) => {
                    fileSystem.stat(path).then((res) => {
                        cb(undefined, res);
                    }, (error) => {
                        cb(error, undefined);
                    });
                }
            };
            compiler.outputFileSystem = {
                join: path_1.join,
                mkdir: (path, cb) => cb(undefined),
                mkdirp: (path, cb) => cb(undefined),
                rmdir: (path, cb) => cb(undefined),
                unlink: (path, cb) => cb(undefined),
                writeFile: (path, data, cb) => cb(undefined)
            };
            compiler.context = '/';
            compiler.run(async (err, stats) => {
                if (err) {
                    reject(err);
                }
                else if (stats.compilation.assets['bundle.js'] === undefined) {
                    reject(new Error('no output generated'));
                }
                else {
                    resolve(stats.compilation.assets['bundle.js'].source());
                }
            });
        });
    }
}
exports.webpack = new Webpack();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2suanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6IndlYnBhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG5jb25zdCBwYXRoXzEgPSByZXF1aXJlKFwicGF0aFwiKTtcbmNvbnN0IHdwID0gcmVxdWlyZShcIndlYnBhY2tcIik7XG5jbGFzcyBXZWJwYWNrIHtcbiAgICBjcmVhdGVCdW5kbGUoZmlsZVN5c3RlbSwgb3B0aW9ucykge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdmFyIF9hO1xuICAgICAgICAgICAgY29uc3QgY29uZmlnID0ge1xuICAgICAgICAgICAgICAgIG1vZGU6IChfYSA9IG9wdGlvbnMubW9kZSwgKF9hICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6ICdkZXZlbG9wbWVudCcpKSxcbiAgICAgICAgICAgICAgICBlbnRyeTogb3B0aW9ucy5lbnRyeSxcbiAgICAgICAgICAgICAgICBvdXRwdXQ6IHtcbiAgICAgICAgICAgICAgICAgICAgZmlsZW5hbWU6ICdidW5kbGUuanMnLFxuICAgICAgICAgICAgICAgICAgICBwYXRoOiAnL291dCcsXG4gICAgICAgICAgICAgICAgICAgIGxpYnJhcnk6IG9wdGlvbnMubW9kdWxlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgbGlicmFyeVRhcmdldDogJ2FtZCdcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGNvbnRleHQ6ICcvJyxcbiAgICAgICAgICAgICAgICByZXNvbHZlOiB7XG4gICAgICAgICAgICAgICAgICAgIGV4dGVuc2lvbnM6IFsnLmpzJywgJy5qc29uJ11cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGV4dGVybmFsczogb3B0aW9ucy5leHRlcm5hbHNcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBjb25zdCBjb21waWxlciA9IHdwKGNvbmZpZyk7XG4gICAgICAgICAgICBjb21waWxlci5pbnB1dEZpbGVTeXN0ZW0gPSB7XG4gICAgICAgICAgICAgICAgcmVhZEZpbGVTeW5jOiAocGF0aCkgPT4gZmlsZVN5c3RlbS5yZWFkRmlsZVN5bmMocGF0aCksXG4gICAgICAgICAgICAgICAgcmVhZGxpbmtTeW5jOiAocGF0aCkgPT4gZmlsZVN5c3RlbS5yZWFkbGlua1N5bmMocGF0aCksXG4gICAgICAgICAgICAgICAgc3RhdFN5bmM6IChwYXRoKSA9PiBmaWxlU3lzdGVtLnN0YXRTeW5jKHBhdGgpLFxuICAgICAgICAgICAgICAgIHJlYWRGaWxlOiAocGF0aCwgY2IpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbS5yZWFkRmlsZShwYXRoLCAndXRmOCcpLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2IodW5kZWZpbmVkLCBCdWZmZXIuZnJvbShyZXMpKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYihlcnJvciwgdW5kZWZpbmVkKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByZWFkbGluazogKHBhdGgsIGNiKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVTeXN0ZW0ucmVhZGxpbmsocGF0aCkudGhlbigocmVzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYih1bmRlZmluZWQsIHJlcyk7XG4gICAgICAgICAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2IoZXJyb3IsIHVuZGVmaW5lZCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc3RhdDogKHBhdGgsIGNiKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVTeXN0ZW0uc3RhdChwYXRoKS50aGVuKChyZXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNiKHVuZGVmaW5lZCwgcmVzKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYihlcnJvciwgdW5kZWZpbmVkKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNvbXBpbGVyLm91dHB1dEZpbGVTeXN0ZW0gPSB7XG4gICAgICAgICAgICAgICAgam9pbjogcGF0aF8xLmpvaW4sXG4gICAgICAgICAgICAgICAgbWtkaXI6IChwYXRoLCBjYikgPT4gY2IodW5kZWZpbmVkKSxcbiAgICAgICAgICAgICAgICBta2RpcnA6IChwYXRoLCBjYikgPT4gY2IodW5kZWZpbmVkKSxcbiAgICAgICAgICAgICAgICBybWRpcjogKHBhdGgsIGNiKSA9PiBjYih1bmRlZmluZWQpLFxuICAgICAgICAgICAgICAgIHVubGluazogKHBhdGgsIGNiKSA9PiBjYih1bmRlZmluZWQpLFxuICAgICAgICAgICAgICAgIHdyaXRlRmlsZTogKHBhdGgsIGRhdGEsIGNiKSA9PiBjYih1bmRlZmluZWQpXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY29tcGlsZXIuY29udGV4dCA9ICcvJztcbiAgICAgICAgICAgIGNvbXBpbGVyLnJ1bihhc3luYyAoZXJyLCBzdGF0cykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHN0YXRzLmNvbXBpbGF0aW9uLmFzc2V0c1snYnVuZGxlLmpzJ10gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCdubyBvdXRwdXQgZ2VuZXJhdGVkJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShzdGF0cy5jb21waWxhdGlvbi5hc3NldHNbJ2J1bmRsZS5qcyddLnNvdXJjZSgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuZXhwb3J0cy53ZWJwYWNrID0gbmV3IFdlYnBhY2soKTtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWRhdGE6YXBwbGljYXRpb24vanNvbjtiYXNlNjQsZXlKMlpYSnphVzl1SWpvekxDSm1hV3hsSWpvaWQyVmljR0ZqYXk1cWN5SXNJbk52ZFhKalpWSnZiM1FpT2lJaUxDSnpiM1Z5WTJWeklqcGJJbmRsWW5CaFkyc3Vhbk1pWFN3aWJtRnRaWE1pT2x0ZExDSnRZWEJ3YVc1bmN5STZJanM3UVVGQlFTd3JRa0ZCTkVJN1FVRkROVUlzT0VKQlFUaENPMEZCUXpsQ0xFMUJRVTBzVDBGQlR6dEpRVU5VTEZsQlFWa3NRMEZCUXl4VlFVRlZMRVZCUVVVc1QwRkJUenRSUVVNMVFpeFBRVUZQTEVsQlFVa3NUMEZCVHl4RFFVRkRMRU5CUVVNc1QwRkJUeXhGUVVGRkxFMUJRVTBzUlVGQlJTeEZRVUZGTzFsQlEyNURMRWxCUVVrc1JVRkJSU3hEUVVGRE8xbEJRMUFzVFVGQlRTeE5RVUZOTEVkQlFVYzdaMEpCUTFnc1NVRkJTU3hGUVVGRkxFTkJRVU1zUlVGQlJTeEhRVUZITEU5QlFVOHNRMEZCUXl4SlFVRkpMRVZCUVVVc1EwRkJReXhGUVVGRkxFdEJRVXNzU1VGQlNTeEpRVUZKTEVWQlFVVXNTMEZCU3l4TFFVRkxMRU5CUVVNc1EwRkJReXhEUVVGRExFTkJRVU1zUlVGQlJTeERRVUZETEVOQlFVTXNRMEZCUXl4aFFVRmhMRU5CUVVNc1EwRkJRenRuUWtGRE9VVXNTMEZCU3l4RlFVRkZMRTlCUVU4c1EwRkJReXhMUVVGTE8yZENRVU53UWl4TlFVRk5MRVZCUVVVN2IwSkJRMG9zVVVGQlVTeEZRVUZGTEZkQlFWYzdiMEpCUTNKQ0xFbEJRVWtzUlVGQlJTeE5RVUZOTzI5Q1FVTmFMRTlCUVU4c1JVRkJSU3hQUVVGUExFTkJRVU1zVlVGQlZUdHZRa0ZETTBJc1lVRkJZU3hGUVVGRkxFdEJRVXM3YVVKQlEzWkNPMmRDUVVORUxFOUJRVThzUlVGQlJTeEhRVUZITzJkQ1FVTmFMRTlCUVU4c1JVRkJSVHR2UWtGRFRDeFZRVUZWTEVWQlFVVXNRMEZCUXl4TFFVRkxMRVZCUVVVc1QwRkJUeXhEUVVGRE8ybENRVU12UWp0blFrRkRSQ3hUUVVGVExFVkJRVVVzVDBGQlR5eERRVUZETEZOQlFWTTdZVUZETDBJc1EwRkJRenRaUVVOR0xFMUJRVTBzVVVGQlVTeEhRVUZITEVWQlFVVXNRMEZCUXl4TlFVRk5MRU5CUVVNc1EwRkJRenRaUVVNMVFpeFJRVUZSTEVOQlFVTXNaVUZCWlN4SFFVRkhPMmRDUVVOMlFpeFpRVUZaTEVWQlFVVXNRMEZCUXl4SlFVRkpMRVZCUVVVc1JVRkJSU3hEUVVGRExGVkJRVlVzUTBGQlF5eFpRVUZaTEVOQlFVTXNTVUZCU1N4RFFVRkRPMmRDUVVOeVJDeFpRVUZaTEVWQlFVVXNRMEZCUXl4SlFVRkpMRVZCUVVVc1JVRkJSU3hEUVVGRExGVkJRVlVzUTBGQlF5eFpRVUZaTEVOQlFVTXNTVUZCU1N4RFFVRkRPMmRDUVVOeVJDeFJRVUZSTEVWQlFVVXNRMEZCUXl4SlFVRkpMRVZCUVVVc1JVRkJSU3hEUVVGRExGVkJRVlVzUTBGQlF5eFJRVUZSTEVOQlFVTXNTVUZCU1N4RFFVRkRPMmRDUVVNM1F5eFJRVUZSTEVWQlFVVXNRMEZCUXl4SlFVRkpMRVZCUVVVc1JVRkJSU3hGUVVGRkxFVkJRVVU3YjBKQlEyNUNMRlZCUVZVc1EwRkJReXhSUVVGUkxFTkJRVU1zU1VGQlNTeEZRVUZGTEUxQlFVMHNRMEZCUXl4RFFVRkRMRWxCUVVrc1EwRkJReXhEUVVGRExFZEJRVWNzUlVGQlJTeEZRVUZGTzNkQ1FVTXpReXhGUVVGRkxFTkJRVU1zVTBGQlV5eEZRVUZGTEUxQlFVMHNRMEZCUXl4SlFVRkpMRU5CUVVNc1IwRkJSeXhEUVVGRExFTkJRVU1zUTBGQlF6dHZRa0ZEY0VNc1EwRkJReXhGUVVGRkxFTkJRVU1zUzBGQlN5eEZRVUZGTEVWQlFVVTdkMEpCUTFRc1JVRkJSU3hEUVVGRExFdEJRVXNzUlVGQlJTeFRRVUZUTEVOQlFVTXNRMEZCUXp0dlFrRkRla0lzUTBGQlF5eERRVUZETEVOQlFVTTdaMEpCUTFBc1EwRkJRenRuUWtGRFJDeFJRVUZSTEVWQlFVVXNRMEZCUXl4SlFVRkpMRVZCUVVVc1JVRkJSU3hGUVVGRkxFVkJRVVU3YjBKQlEyNUNMRlZCUVZVc1EwRkJReXhSUVVGUkxFTkJRVU1zU1VGQlNTeERRVUZETEVOQlFVTXNTVUZCU1N4RFFVRkRMRU5CUVVNc1IwRkJSeXhGUVVGRkxFVkJRVVU3ZDBKQlEyNURMRVZCUVVVc1EwRkJReXhUUVVGVExFVkJRVVVzUjBGQlJ5eERRVUZETEVOQlFVTTdiMEpCUTNaQ0xFTkJRVU1zUlVGQlJTeERRVUZETEV0QlFVc3NSVUZCUlN4RlFVRkZPM2RDUVVOVUxFVkJRVVVzUTBGQlF5eExRVUZMTEVWQlFVVXNVMEZCVXl4RFFVRkRMRU5CUVVNN2IwSkJRM3BDTEVOQlFVTXNRMEZCUXl4RFFVRkRPMmRDUVVOUUxFTkJRVU03WjBKQlEwUXNTVUZCU1N4RlFVRkZMRU5CUVVNc1NVRkJTU3hGUVVGRkxFVkJRVVVzUlVGQlJTeEZRVUZGTzI5Q1FVTm1MRlZCUVZVc1EwRkJReXhKUVVGSkxFTkJRVU1zU1VGQlNTeERRVUZETEVOQlFVTXNTVUZCU1N4RFFVRkRMRU5CUVVNc1IwRkJSeXhGUVVGRkxFVkJRVVU3ZDBKQlF5OUNMRVZCUVVVc1EwRkJReXhUUVVGVExFVkJRVVVzUjBGQlJ5eERRVUZETEVOQlFVTTdiMEpCUTNaQ0xFTkJRVU1zUlVGQlJTeERRVUZETEV0QlFVc3NSVUZCUlN4RlFVRkZPM2RDUVVOVUxFVkJRVVVzUTBGQlF5eExRVUZMTEVWQlFVVXNVMEZCVXl4RFFVRkRMRU5CUVVNN2IwSkJRM3BDTEVOQlFVTXNRMEZCUXl4RFFVRkRPMmRDUVVOUUxFTkJRVU03WVVGRFNpeERRVUZETzFsQlEwWXNVVUZCVVN4RFFVRkRMR2RDUVVGblFpeEhRVUZITzJkQ1FVTjRRaXhKUVVGSkxFVkJRVW9zVjBGQlNUdG5Ra0ZEU2l4TFFVRkxMRVZCUVVVc1EwRkJReXhKUVVGSkxFVkJRVVVzUlVGQlJTeEZRVUZGTEVWQlFVVXNRMEZCUXl4RlFVRkZMRU5CUVVNc1UwRkJVeXhEUVVGRE8yZENRVU5zUXl4TlFVRk5MRVZCUVVVc1EwRkJReXhKUVVGSkxFVkJRVVVzUlVGQlJTeEZRVUZGTEVWQlFVVXNRMEZCUXl4RlFVRkZMRU5CUVVNc1UwRkJVeXhEUVVGRE8yZENRVU51UXl4TFFVRkxMRVZCUVVVc1EwRkJReXhKUVVGSkxFVkJRVVVzUlVGQlJTeEZRVUZGTEVWQlFVVXNRMEZCUXl4RlFVRkZMRU5CUVVNc1UwRkJVeXhEUVVGRE8yZENRVU5zUXl4TlFVRk5MRVZCUVVVc1EwRkJReXhKUVVGSkxFVkJRVVVzUlVGQlJTeEZRVUZGTEVWQlFVVXNRMEZCUXl4RlFVRkZMRU5CUVVNc1UwRkJVeXhEUVVGRE8yZENRVU51UXl4VFFVRlRMRVZCUVVVc1EwRkJReXhKUVVGSkxFVkJRVVVzU1VGQlNTeEZRVUZGTEVWQlFVVXNSVUZCUlN4RlFVRkZMRU5CUVVNc1JVRkJSU3hEUVVGRExGTkJRVk1zUTBGQlF6dGhRVU12UXl4RFFVRkRPMWxCUTBZc1VVRkJVU3hEUVVGRExFOUJRVThzUjBGQlJ5eEhRVUZITEVOQlFVTTdXVUZEZGtJc1VVRkJVU3hEUVVGRExFZEJRVWNzUTBGQlF5eExRVUZMTEVWQlFVVXNSMEZCUnl4RlFVRkZMRXRCUVVzc1JVRkJSU3hGUVVGRk8yZENRVU01UWl4SlFVRkpMRWRCUVVjc1JVRkJSVHR2UWtGRFRDeE5RVUZOTEVOQlFVTXNSMEZCUnl4RFFVRkRMRU5CUVVNN2FVSkJRMlk3Y1VKQlEwa3NTVUZCU1N4TFFVRkxMRU5CUVVNc1YwRkJWeXhEUVVGRExFMUJRVTBzUTBGQlF5eFhRVUZYTEVOQlFVTXNTMEZCU3l4VFFVRlRMRVZCUVVVN2IwSkJRekZFTEUxQlFVMHNRMEZCUXl4SlFVRkpMRXRCUVVzc1EwRkJReXh4UWtGQmNVSXNRMEZCUXl4RFFVRkRMRU5CUVVNN2FVSkJRelZETzNGQ1FVTkpPMjlDUVVORUxFOUJRVThzUTBGQlF5eExRVUZMTEVOQlFVTXNWMEZCVnl4RFFVRkRMRTFCUVUwc1EwRkJReXhYUVVGWExFTkJRVU1zUTBGQlF5eE5RVUZOTEVWQlFVVXNRMEZCUXl4RFFVRkRPMmxDUVVNelJEdFpRVU5NTEVOQlFVTXNRMEZCUXl4RFFVRkRPMUZCUTFBc1EwRkJReXhEUVVGRExFTkJRVU03U1VGRFVDeERRVUZETzBOQlEwbzdRVUZEV1N4UlFVRkJMRTlCUVU4c1IwRkJSeXhKUVVGSkxFOUJRVThzUlVGQlJTeERRVUZESW4wPSJdfQ==