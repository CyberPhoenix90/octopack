"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const combine = require("combine-source-map");
const convert_source_map_1 = require("convert-source-map");
const ts = require("typescript");
const static_analyser_1 = require("static_analyser");
async function transpile(model, context) {
    for (const file of model.output) {
        if (file.includes('.js')) {
            const originalContent = await model.fileSystem.readFile(file, 'utf8');
            let content;
            let mappedFile;
            const sourceMapIndex = originalContent.indexOf('\n//# sourceMappingURL=');
            if (sourceMapIndex !== -1) {
                content = originalContent.substring(0, sourceMapIndex);
                mappedFile = convert_source_map_1.fromComment(originalContent.substring(sourceMapIndex + 1)).toObject().file;
            }
            else {
                content = originalContent;
            }
            const fm = new static_analyser_1.FileManipulator(content, ts.ScriptKind.JS);
            if (!fm.isModule()) {
                continue;
            }
            const output = ts.transpileModule(content, {
                compilerOptions: {
                    target: ts.ScriptTarget.ESNext,
                    module: model.project.resolvedConfig.platform === 'browser'
                        ? ts.ModuleKind.UMD
                        : ts.ModuleKind.CommonJS,
                    inlineSourceMap: true
                },
                fileName: file
            });
            if (output.outputText) {
                let result = output.outputText.substring(0, output.outputText.indexOf('\n//# sourceMappingURL='));
                if (sourceMapIndex !== -1) {
                    result +=
                        '\n' +
                            combine
                                .create(mappedFile)
                                .addFile({
                                source: originalContent,
                                sourceFile: mappedFile
                            })
                                .addFile({ source: output.outputText, sourceFile: mappedFile })
                                .comment();
                }
                await model.fileSystem.writeFile(file, result);
            }
            else {
                for (const diagnostic of output.diagnostics) {
                    const { line, character } = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);
                    const message = ts.flattenDiagnosticMessageText(diagnostic.messageText, '\n');
                    context.uiLogger.error(`[${model.project.resolvedConfig.name}]${diagnostic.file.fileName} (${line + 1},${character +
                        1}): ${message}`);
                }
            }
        }
    }
}
exports.transpile = transpile;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZV90cmFuc3BpbGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJtb2R1bGVfdHJhbnNwaWxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IGNvbWJpbmUgPSByZXF1aXJlKFwiY29tYmluZS1zb3VyY2UtbWFwXCIpO1xuY29uc3QgY29udmVydF9zb3VyY2VfbWFwXzEgPSByZXF1aXJlKFwiY29udmVydC1zb3VyY2UtbWFwXCIpO1xuY29uc3QgdHMgPSByZXF1aXJlKFwidHlwZXNjcmlwdFwiKTtcbmNvbnN0IHN0YXRpY19hbmFseXNlcl8xID0gcmVxdWlyZShcInN0YXRpY19hbmFseXNlclwiKTtcbmFzeW5jIGZ1bmN0aW9uIHRyYW5zcGlsZShtb2RlbCwgY29udGV4dCkge1xuICAgIGZvciAoY29uc3QgZmlsZSBvZiBtb2RlbC5vdXRwdXQpIHtcbiAgICAgICAgaWYgKGZpbGUuaW5jbHVkZXMoJy5qcycpKSB7XG4gICAgICAgICAgICBjb25zdCBvcmlnaW5hbENvbnRlbnQgPSBhd2FpdCBtb2RlbC5maWxlU3lzdGVtLnJlYWRGaWxlKGZpbGUsICd1dGY4Jyk7XG4gICAgICAgICAgICBsZXQgY29udGVudDtcbiAgICAgICAgICAgIGxldCBtYXBwZWRGaWxlO1xuICAgICAgICAgICAgY29uc3Qgc291cmNlTWFwSW5kZXggPSBvcmlnaW5hbENvbnRlbnQuaW5kZXhPZignXFxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9Jyk7XG4gICAgICAgICAgICBpZiAoc291cmNlTWFwSW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgY29udGVudCA9IG9yaWdpbmFsQ29udGVudC5zdWJzdHJpbmcoMCwgc291cmNlTWFwSW5kZXgpO1xuICAgICAgICAgICAgICAgIG1hcHBlZEZpbGUgPSBjb252ZXJ0X3NvdXJjZV9tYXBfMS5mcm9tQ29tbWVudChvcmlnaW5hbENvbnRlbnQuc3Vic3RyaW5nKHNvdXJjZU1hcEluZGV4ICsgMSkpLnRvT2JqZWN0KCkuZmlsZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBvcmlnaW5hbENvbnRlbnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBmbSA9IG5ldyBzdGF0aWNfYW5hbHlzZXJfMS5GaWxlTWFuaXB1bGF0b3IoY29udGVudCwgdHMuU2NyaXB0S2luZC5KUyk7XG4gICAgICAgICAgICBpZiAoIWZtLmlzTW9kdWxlKCkpIHtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IHRzLnRyYW5zcGlsZU1vZHVsZShjb250ZW50LCB7XG4gICAgICAgICAgICAgICAgY29tcGlsZXJPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldDogdHMuU2NyaXB0VGFyZ2V0LkVTTmV4dCxcbiAgICAgICAgICAgICAgICAgICAgbW9kdWxlOiBtb2RlbC5wcm9qZWN0LnJlc29sdmVkQ29uZmlnLnBsYXRmb3JtID09PSAnYnJvd3NlcidcbiAgICAgICAgICAgICAgICAgICAgICAgID8gdHMuTW9kdWxlS2luZC5VTURcbiAgICAgICAgICAgICAgICAgICAgICAgIDogdHMuTW9kdWxlS2luZC5Db21tb25KUyxcbiAgICAgICAgICAgICAgICAgICAgaW5saW5lU291cmNlTWFwOiB0cnVlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBmaWxlTmFtZTogZmlsZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAob3V0cHV0Lm91dHB1dFRleHQpIHtcbiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gb3V0cHV0Lm91dHB1dFRleHQuc3Vic3RyaW5nKDAsIG91dHB1dC5vdXRwdXRUZXh0LmluZGV4T2YoJ1xcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPScpKTtcbiAgICAgICAgICAgICAgICBpZiAoc291cmNlTWFwSW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPVxuICAgICAgICAgICAgICAgICAgICAgICAgJ1xcbicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbWJpbmVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNyZWF0ZShtYXBwZWRGaWxlKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYWRkRmlsZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZTogb3JpZ2luYWxDb250ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VGaWxlOiBtYXBwZWRGaWxlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFkZEZpbGUoeyBzb3VyY2U6IG91dHB1dC5vdXRwdXRUZXh0LCBzb3VyY2VGaWxlOiBtYXBwZWRGaWxlIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jb21tZW50KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGF3YWl0IG1vZGVsLmZpbGVTeXN0ZW0ud3JpdGVGaWxlKGZpbGUsIHJlc3VsdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGRpYWdub3N0aWMgb2Ygb3V0cHV0LmRpYWdub3N0aWNzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGluZSwgY2hhcmFjdGVyIH0gPSBkaWFnbm9zdGljLmZpbGUuZ2V0TGluZUFuZENoYXJhY3Rlck9mUG9zaXRpb24oZGlhZ25vc3RpYy5zdGFydCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0cy5mbGF0dGVuRGlhZ25vc3RpY01lc3NhZ2VUZXh0KGRpYWdub3N0aWMubWVzc2FnZVRleHQsICdcXG4nKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dC51aUxvZ2dlci5lcnJvcihgWyR7bW9kZWwucHJvamVjdC5yZXNvbHZlZENvbmZpZy5uYW1lfV0ke2RpYWdub3N0aWMuZmlsZS5maWxlTmFtZX0gKCR7bGluZSArIDF9LCR7Y2hhcmFjdGVyICtcbiAgICAgICAgICAgICAgICAgICAgICAgIDF9KTogJHttZXNzYWdlfWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cbmV4cG9ydHMudHJhbnNwaWxlID0gdHJhbnNwaWxlO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZGF0YTphcHBsaWNhdGlvbi9qc29uO2Jhc2U2NCxleUoyWlhKemFXOXVJam96TENKbWFXeGxJam9pYlc5a2RXeGxYM1J5WVc1emNHbHNaWEl1YW5NaUxDSnpiM1Z5WTJWU2IyOTBJam9pSWl3aWMyOTFjbU5sY3lJNld5SnRiMlIxYkdWZmRISmhibk53YVd4bGNpNXFjeUpkTENKdVlXMWxjeUk2VzEwc0ltMWhjSEJwYm1keklqb2lPenRCUVVGQkxEaERRVUU0UXp0QlFVTTVReXd5UkVGQmFVUTdRVUZEYWtRc2FVTkJRV2xETzBGQlEycERMSEZFUVVGclJEdEJRVU16UXl4TFFVRkxMRlZCUVZVc1UwRkJVeXhEUVVGRExFdEJRVXNzUlVGQlJTeFBRVUZQTzBsQlF6RkRMRXRCUVVzc1RVRkJUU3hKUVVGSkxFbEJRVWtzUzBGQlN5eERRVUZETEUxQlFVMHNSVUZCUlR0UlFVTTNRaXhKUVVGSkxFbEJRVWtzUTBGQlF5eFJRVUZSTEVOQlFVTXNTMEZCU3l4RFFVRkRMRVZCUVVVN1dVRkRkRUlzVFVGQlRTeGxRVUZsTEVkQlFVY3NUVUZCVFN4TFFVRkxMRU5CUVVNc1ZVRkJWU3hEUVVGRExGRkJRVkVzUTBGQlF5eEpRVUZKTEVWQlFVVXNUVUZCVFN4RFFVRkRMRU5CUVVNN1dVRkRkRVVzU1VGQlNTeFBRVUZQTEVOQlFVTTdXVUZEV2l4SlFVRkpMRlZCUVZVc1EwRkJRenRaUVVObUxFMUJRVTBzWTBGQll5eEhRVUZITEdWQlFXVXNRMEZCUXl4UFFVRlBMRU5CUVVNc2VVSkJRWGxDTEVOQlFVTXNRMEZCUXp0WlFVTXhSU3hKUVVGSkxHTkJRV01zUzBGQlN5eERRVUZETEVOQlFVTXNSVUZCUlR0blFrRkRka0lzVDBGQlR5eEhRVUZITEdWQlFXVXNRMEZCUXl4VFFVRlRMRU5CUVVNc1EwRkJReXhGUVVGRkxHTkJRV01zUTBGQlF5eERRVUZETzJkQ1FVTjJSQ3hWUVVGVkxFZEJRVWNzWjBOQlFWY3NRMEZCUXl4bFFVRmxMRU5CUVVNc1UwRkJVeXhEUVVGRExHTkJRV01zUjBGQlJ5eERRVUZETEVOQlFVTXNRMEZCUXl4RFFVRkRMRkZCUVZFc1JVRkJSU3hEUVVGRExFbEJRVWtzUTBGQlF6dGhRVU16Ump0cFFrRkRTVHRuUWtGRFJDeFBRVUZQTEVkQlFVY3NaVUZCWlN4RFFVRkRPMkZCUXpkQ08xbEJRMFFzVFVGQlRTeEZRVUZGTEVkQlFVY3NTVUZCU1N4cFEwRkJaU3hEUVVGRExFOUJRVThzUlVGQlJTeEZRVUZGTEVOQlFVTXNWVUZCVlN4RFFVRkRMRVZCUVVVc1EwRkJReXhEUVVGRE8xbEJRekZFTEVsQlFVa3NRMEZCUXl4RlFVRkZMRU5CUVVNc1VVRkJVU3hGUVVGRkxFVkJRVVU3WjBKQlEyaENMRk5CUVZNN1lVRkRXanRaUVVORUxFMUJRVTBzVFVGQlRTeEhRVUZITEVWQlFVVXNRMEZCUXl4bFFVRmxMRU5CUVVNc1QwRkJUeXhGUVVGRk8yZENRVU4yUXl4bFFVRmxMRVZCUVVVN2IwSkJRMklzVFVGQlRTeEZRVUZGTEVWQlFVVXNRMEZCUXl4WlFVRlpMRU5CUVVNc1RVRkJUVHR2UWtGRE9VSXNUVUZCVFN4RlFVRkZMRXRCUVVzc1EwRkJReXhQUVVGUExFTkJRVU1zWTBGQll5eERRVUZETEZGQlFWRXNTMEZCU3l4VFFVRlRPM2RDUVVOMlJDeERRVUZETEVOQlFVTXNSVUZCUlN4RFFVRkRMRlZCUVZVc1EwRkJReXhIUVVGSE8zZENRVU51UWl4RFFVRkRMRU5CUVVNc1JVRkJSU3hEUVVGRExGVkJRVlVzUTBGQlF5eFJRVUZSTzI5Q1FVTTFRaXhsUVVGbExFVkJRVVVzU1VGQlNUdHBRa0ZEZUVJN1owSkJRMFFzVVVGQlVTeEZRVUZGTEVsQlFVazdZVUZEYWtJc1EwRkJReXhEUVVGRE8xbEJRMGdzU1VGQlNTeE5RVUZOTEVOQlFVTXNWVUZCVlN4RlFVRkZPMmRDUVVOdVFpeEpRVUZKTEUxQlFVMHNSMEZCUnl4TlFVRk5MRU5CUVVNc1ZVRkJWU3hEUVVGRExGTkJRVk1zUTBGQlF5eERRVUZETEVWQlFVVXNUVUZCVFN4RFFVRkRMRlZCUVZVc1EwRkJReXhQUVVGUExFTkJRVU1zZVVKQlFYbENMRU5CUVVNc1EwRkJReXhEUVVGRE8yZENRVU5zUnl4SlFVRkpMR05CUVdNc1MwRkJTeXhEUVVGRExFTkJRVU1zUlVGQlJUdHZRa0ZEZGtJc1RVRkJUVHQzUWtGRFJpeEpRVUZKT3pSQ1FVTkJMRTlCUVU4N2FVTkJRMFlzVFVGQlRTeERRVUZETEZWQlFWVXNRMEZCUXp0cFEwRkRiRUlzVDBGQlR5eERRVUZETzJkRFFVTlVMRTFCUVUwc1JVRkJSU3hsUVVGbE8yZERRVU4yUWl4VlFVRlZMRVZCUVVVc1ZVRkJWVHMyUWtGRGVrSXNRMEZCUXp0cFEwRkRSeXhQUVVGUExFTkJRVU1zUlVGQlJTeE5RVUZOTEVWQlFVVXNUVUZCVFN4RFFVRkRMRlZCUVZVc1JVRkJSU3hWUVVGVkxFVkJRVVVzVlVGQlZTeEZRVUZGTEVOQlFVTTdhVU5CUXpsRUxFOUJRVThzUlVGQlJTeERRVUZETzJsQ1FVTXhRanRuUWtGRFJDeE5RVUZOTEV0QlFVc3NRMEZCUXl4VlFVRlZMRU5CUVVNc1UwRkJVeXhEUVVGRExFbEJRVWtzUlVGQlJTeE5RVUZOTEVOQlFVTXNRMEZCUXp0aFFVTnNSRHRwUWtGRFNUdG5Ra0ZEUkN4TFFVRkxMRTFCUVUwc1ZVRkJWU3hKUVVGSkxFMUJRVTBzUTBGQlF5eFhRVUZYTEVWQlFVVTdiMEpCUTNwRExFMUJRVTBzUlVGQlJTeEpRVUZKTEVWQlFVVXNVMEZCVXl4RlFVRkZMRWRCUVVjc1ZVRkJWU3hEUVVGRExFbEJRVWtzUTBGQlF5dzJRa0ZCTmtJc1EwRkJReXhWUVVGVkxFTkJRVU1zUzBGQlN5eERRVUZETEVOQlFVTTdiMEpCUXpWR0xFMUJRVTBzVDBGQlR5eEhRVUZITEVWQlFVVXNRMEZCUXl3MFFrRkJORUlzUTBGQlF5eFZRVUZWTEVOQlFVTXNWMEZCVnl4RlFVRkZMRWxCUVVrc1EwRkJReXhEUVVGRE8yOUNRVU01UlN4UFFVRlBMRU5CUVVNc1VVRkJVU3hEUVVGRExFdEJRVXNzUTBGQlF5eEpRVUZKTEV0QlFVc3NRMEZCUXl4UFFVRlBMRU5CUVVNc1kwRkJZeXhEUVVGRExFbEJRVWtzU1VGQlNTeFZRVUZWTEVOQlFVTXNTVUZCU1N4RFFVRkRMRkZCUVZFc1MwRkJTeXhKUVVGSkxFZEJRVWNzUTBGQlF5eEpRVUZKTEZOQlFWTTdkMEpCUXpsSExFTkJRVU1zVFVGQlRTeFBRVUZQTEVWQlFVVXNRMEZCUXl4RFFVRkRPMmxDUVVONlFqdGhRVU5LTzFOQlEwbzdTMEZEU2p0QlFVTk1MRU5CUVVNN1FVRjBSRVFzT0VKQmMwUkRJbjA9Il19