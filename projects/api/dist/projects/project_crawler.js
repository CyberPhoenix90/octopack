"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = require("path");
const config_resolver_1 = require("config_resolver");
class ProjectCrawler {
    async findProjects(root, context) {
        if (!this.cache) {
            const result = [];
            await this.searchDirectory(result, root, context);
            this.cache = result;
        }
        return this.cache;
    }
    async searchDirectory(result, path, context) {
        if (await context.fileSystem.exists(path_1.join(path, config_resolver_1.OCTOPACK_CONFIG_FILE_NAME))) {
            const config = await config_resolver_1.loadConfig(path, context.fileSystem);
            if (config.scope === 'project') {
                result.push({
                    path,
                    rawConfig: config,
                    resolvedConfig: config_resolver_1.resolveConfig({
                        project: config,
                        workspace: context.workspaceConfig
                    })
                });
            }
            else {
                await this.crawSubfolders(context, path, result);
            }
        }
        else {
            await this.crawSubfolders(context, path, result);
        }
    }
    async crawSubfolders(context, path, result) {
        const directories = await context.fileSystem.getSubfolders(path);
        for (const dir of directories) {
            await this.searchDirectory(result, dir, context);
        }
    }
}
exports.ProjectCrawler = ProjectCrawler;
exports.projectCrawler = new ProjectCrawler();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb2plY3RfY3Jhd2xlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InByb2plY3RfY3Jhd2xlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmNvbnN0IHBhdGhfMSA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuY29uc3QgY29uZmlnX3Jlc29sdmVyXzEgPSByZXF1aXJlKFwiY29uZmlnX3Jlc29sdmVyXCIpO1xuY2xhc3MgUHJvamVjdENyYXdsZXIge1xuICAgIGFzeW5jIGZpbmRQcm9qZWN0cyhyb290LCBjb250ZXh0KSB7XG4gICAgICAgIGlmICghdGhpcy5jYWNoZSkge1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gW107XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnNlYXJjaERpcmVjdG9yeShyZXN1bHQsIHJvb3QsIGNvbnRleHQpO1xuICAgICAgICAgICAgdGhpcy5jYWNoZSA9IHJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jYWNoZTtcbiAgICB9XG4gICAgYXN5bmMgc2VhcmNoRGlyZWN0b3J5KHJlc3VsdCwgcGF0aCwgY29udGV4dCkge1xuICAgICAgICBpZiAoYXdhaXQgY29udGV4dC5maWxlU3lzdGVtLmV4aXN0cyhwYXRoXzEuam9pbihwYXRoLCBjb25maWdfcmVzb2x2ZXJfMS5PQ1RPUEFDS19DT05GSUdfRklMRV9OQU1FKSkpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IGF3YWl0IGNvbmZpZ19yZXNvbHZlcl8xLmxvYWRDb25maWcocGF0aCwgY29udGV4dC5maWxlU3lzdGVtKTtcbiAgICAgICAgICAgIGlmIChjb25maWcuc2NvcGUgPT09ICdwcm9qZWN0Jykge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgICAgICAgICAgcmF3Q29uZmlnOiBjb25maWcsXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmVkQ29uZmlnOiBjb25maWdfcmVzb2x2ZXJfMS5yZXNvbHZlQ29uZmlnKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2plY3Q6IGNvbmZpZyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmtzcGFjZTogY29udGV4dC53b3Jrc3BhY2VDb25maWdcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuY3Jhd1N1YmZvbGRlcnMoY29udGV4dCwgcGF0aCwgcmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuY3Jhd1N1YmZvbGRlcnMoY29udGV4dCwgcGF0aCwgcmVzdWx0KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBhc3luYyBjcmF3U3ViZm9sZGVycyhjb250ZXh0LCBwYXRoLCByZXN1bHQpIHtcbiAgICAgICAgY29uc3QgZGlyZWN0b3JpZXMgPSBhd2FpdCBjb250ZXh0LmZpbGVTeXN0ZW0uZ2V0U3ViZm9sZGVycyhwYXRoKTtcbiAgICAgICAgZm9yIChjb25zdCBkaXIgb2YgZGlyZWN0b3JpZXMpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc2VhcmNoRGlyZWN0b3J5KHJlc3VsdCwgZGlyLCBjb250ZXh0KTtcbiAgICAgICAgfVxuICAgIH1cbn1cbmV4cG9ydHMuUHJvamVjdENyYXdsZXIgPSBQcm9qZWN0Q3Jhd2xlcjtcbmV4cG9ydHMucHJvamVjdENyYXdsZXIgPSBuZXcgUHJvamVjdENyYXdsZXIoKTtcbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWRhdGE6YXBwbGljYXRpb24vanNvbjtiYXNlNjQsZXlKMlpYSnphVzl1SWpvekxDSm1hV3hsSWpvaWNISnZhbVZqZEY5amNtRjNiR1Z5TG1weklpd2ljMjkxY21ObFVtOXZkQ0k2SWlJc0luTnZkWEpqWlhNaU9sc2ljSEp2YW1WamRGOWpjbUYzYkdWeUxtcHpJbDBzSW01aGJXVnpJanBiWFN3aWJXRndjR2x1WjNNaU9pSTdPMEZCUVVFc0swSkJRVFJDTzBGQlF6VkNMSEZFUVVGMVJqdEJRVU4yUml4TlFVRmhMR05CUVdNN1NVRkRka0lzUzBGQlN5eERRVUZETEZsQlFWa3NRMEZCUXl4SlFVRkpMRVZCUVVVc1QwRkJUenRSUVVNMVFpeEpRVUZKTEVOQlFVTXNTVUZCU1N4RFFVRkRMRXRCUVVzc1JVRkJSVHRaUVVOaUxFMUJRVTBzVFVGQlRTeEhRVUZITEVWQlFVVXNRMEZCUXp0WlFVTnNRaXhOUVVGTkxFbEJRVWtzUTBGQlF5eGxRVUZsTEVOQlFVTXNUVUZCVFN4RlFVRkZMRWxCUVVrc1JVRkJSU3hQUVVGUExFTkJRVU1zUTBGQlF6dFpRVU5zUkN4SlFVRkpMRU5CUVVNc1MwRkJTeXhIUVVGSExFMUJRVTBzUTBGQlF6dFRRVU4yUWp0UlFVTkVMRTlCUVU4c1NVRkJTU3hEUVVGRExFdEJRVXNzUTBGQlF6dEpRVU4wUWl4RFFVRkRPMGxCUTBRc1MwRkJTeXhEUVVGRExHVkJRV1VzUTBGQlF5eE5RVUZOTEVWQlFVVXNTVUZCU1N4RlFVRkZMRTlCUVU4N1VVRkRka01zU1VGQlNTeE5RVUZOTEU5QlFVOHNRMEZCUXl4VlFVRlZMRU5CUVVNc1RVRkJUU3hEUVVGRExGZEJRVWtzUTBGQlF5eEpRVUZKTEVWQlFVVXNNa05CUVhsQ0xFTkJRVU1zUTBGQlF5eEZRVUZGTzFsQlEzaEZMRTFCUVUwc1RVRkJUU3hIUVVGSExFMUJRVTBzTkVKQlFWVXNRMEZCUXl4SlFVRkpMRVZCUVVVc1QwRkJUeXhEUVVGRExGVkJRVlVzUTBGQlF5eERRVUZETzFsQlF6RkVMRWxCUVVrc1RVRkJUU3hEUVVGRExFdEJRVXNzUzBGQlN5eFRRVUZUTEVWQlFVVTdaMEpCUXpWQ0xFMUJRVTBzUTBGQlF5eEpRVUZKTEVOQlFVTTdiMEpCUTFJc1NVRkJTVHR2UWtGRFNpeFRRVUZUTEVWQlFVVXNUVUZCVFR0dlFrRkRha0lzWTBGQll5eEZRVUZGTEN0Q1FVRmhMRU5CUVVNN2QwSkJRekZDTEU5QlFVOHNSVUZCUlN4TlFVRk5PM2RDUVVObUxGTkJRVk1zUlVGQlJTeFBRVUZQTEVOQlFVTXNaVUZCWlR0eFFrRkRja01zUTBGQlF6dHBRa0ZEVEN4RFFVRkRMRU5CUVVNN1lVRkRUanRwUWtGRFNUdG5Ra0ZEUkN4TlFVRk5MRWxCUVVrc1EwRkJReXhqUVVGakxFTkJRVU1zVDBGQlR5eEZRVUZGTEVsQlFVa3NSVUZCUlN4TlFVRk5MRU5CUVVNc1EwRkJRenRoUVVOd1JEdFRRVU5LTzJGQlEwazdXVUZEUkN4TlFVRk5MRWxCUVVrc1EwRkJReXhqUVVGakxFTkJRVU1zVDBGQlR5eEZRVUZGTEVsQlFVa3NSVUZCUlN4TlFVRk5MRU5CUVVNc1EwRkJRenRUUVVOd1JEdEpRVU5NTEVOQlFVTTdTVUZEUkN4TFFVRkxMRU5CUVVNc1kwRkJZeXhEUVVGRExFOUJRVThzUlVGQlJTeEpRVUZKTEVWQlFVVXNUVUZCVFR0UlFVTjBReXhOUVVGTkxGZEJRVmNzUjBGQlJ5eE5RVUZOTEU5QlFVOHNRMEZCUXl4VlFVRlZMRU5CUVVNc1lVRkJZU3hEUVVGRExFbEJRVWtzUTBGQlF5eERRVUZETzFGQlEycEZMRXRCUVVzc1RVRkJUU3hIUVVGSExFbEJRVWtzVjBGQlZ5eEZRVUZGTzFsQlF6TkNMRTFCUVUwc1NVRkJTU3hEUVVGRExHVkJRV1VzUTBGQlF5eE5RVUZOTEVWQlFVVXNSMEZCUnl4RlFVRkZMRTlCUVU4c1EwRkJReXhEUVVGRE8xTkJRM0JFTzBsQlEwd3NRMEZCUXp0RFFVTktPMEZCY0VORUxIZERRVzlEUXp0QlFVTlpMRkZCUVVFc1kwRkJZeXhIUVVGSExFbEJRVWtzWTBGQll5eEZRVUZGTEVOQlFVTWlmUT09Il19